<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Style-Type" content="text/css; charset=utf-8" />
<meta http-equiv="Content-Script-Type" content="text/javascript; charset=utf-8" />
<meta name="generator" content="vim" />
<meta name="version" content="0.1" />
<meta name="author" content="MaoTsunekawa" />
<title>サーバの負荷を軽くするTIPS</title>
<script type="text/javascript" src="s6.js"></script>
<script type="text/javascript">
// <![CDATA[

var bodyStyle = {
    width: '100%',
    height: '100%',
    padding: '0',
    margin: '0',
    overflow: 'hidden',
    backgroundColor: 'gray'
};

s6.css('html', bodyStyle);
s6.css('body', bodyStyle);

var pr;
s6.attach(s6, 'ready', function ready() {
    var html = document.documentElement;
    var height = html.offsetHeight;
    var width = html.offsetWidth;
    var top = 0;
    var left = 0;

    if (height / width < 0.75) {
        var originalWidth = width;
        width = height / 0.75;
        left = (originalWidth - width) / 2 + 'px';
    }
    else {
        var originalHeight = height;
        height = width * 0.75;
        top = (originalHeight - height) / 2 + 'px';
    }

    var result;
    if (result = document.cookie.match(/page=(\d+)/)) {
        var startIndex = +result[1];
    }

    pr = new s6.Presentation({ element: document.body, width: width, height: height, startIndex: startIndex });
    pr.style.left = left;
    pr.style.top = top;
    pr.start();

    var indexNoOutline = false;

    pr.funcPages.index.attachPage('click', function(i, element, wrapper) {
        indexNoOutline = true;
        setTimeout(function() {
            indexNoOutline =false
        }, 1000);
        wrapper.style.background = '';
        pr.go(i);
    });

    pr.funcPages.index.attachPage('mouseover', function(i, element, wrapper) {
        if (indexNoOutline) return;
        wrapper.className += ' selected';
    });
    
    pr.funcPages.index.attachPage('mouseout', function(i, element, wrapper) {
        wrapper.className = 'wrapper';
    });

    try {
        var isIframe = !(window.parent == window);
    } catch(e) {
        isIframe = true;
    }

    s6.attach(document,   'keypress Right', 'step', 0, pr);
    s6.attach(document,   'keypress Left',  'prev', 0, pr);
    s6.attach(document,   'keypress Up',    function() { pr.go('index') });
    s6.attach(document,   'keypress Down',  'back', 0, pr);
});

// Test
setInterval(function() {
    document.cookie = 'page=' + pr.index;
}, 1000);
// ]]>
</script>
<style>
@media print{
.s6{
  top:0 !IMPORTANT;
  left:0 !IMPORTANT;
  width:180mm !IMPORTANT;
  height:265mm !IMPORTANT;
}

.s6 .index.page .inner.s6 .page .wrapper{
  width:47% !IMPORTANT;
  height:32% !IMPORTANT;
  font-size:40%;
  line-height:1.2;
}}
</style>
</head>
<body>

 <h1>サーバの負荷を<br/>軽くする小技</h1>
 <address>2009/04/06 SILT #8<br/>id:kamipo</address>
 <script type="text/javascript">
   s6.page({ wrap:2, styles: [ { color: 'red' } ] })
 </script>

 <div>
  <h2>noatimeの話</h2>
  <script type="text/javascript">
    s6.page({
       styleBase: 'takahashi'
    });
  </script>
 </div>

 <div>
   <h2>test_open.c</h2>
   <pre style="font-size: 14px;">
#include &lt;stdio.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;fcntl.h&gt;

int main(void) {
    int fdout;

    if ( (fdout = open("./test.txt", O_RDONLY)) == -1){
        printf("open error.¥n");
    }   

    return 0;
}
   </pre>
 </div>
 <div>
   <h2>test_read.c</h2>
   <pre style="font-size: 14px;">
#include &lt;stdio.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;unistd.h&gt;

int main(void) {
    int fdout;
    char ch;

    if ( (fdout = open("./test.txt", O_RDONLY)) == -1){
        printf("open error.¥n");
    }

    while (read(fdout, &ch, 1));

    return 0;
}
   </pre>
 </div>

 <div>
  <h2>stat test.txt</h2>
  <script type="text/javascript">
    s6.page({
       styleBase: 'takahashi'
    });
  </script>
 </div>

 <div>
   <h2>echo hoge > test.txtの後</h2>
   <pre style="font-size: 20px;">
  File: `test.txt'
  Size: 5               Blocks: 8          IO Block: 4096   通常ファイル
Device: 902h/2306d      Inode: 15073327    Links: 1
Access: (0644/-rw-r--r--)  Uid: (10028/  kamipo)   Gid: (  501/     dev)
Access: 2009-04-06 16:44:20.000000000 +0900
Modify: 2009-04-06 16:44:20.000000000 +0900
Change: 2009-04-06 16:44:20.000000000 +0900
   </pre>
 </div>

 <div>
   <h2>./test_openの後</h2>
   <pre style="font-size: 20px;">
  File: `test.txt'
  Size: 5               Blocks: 8          IO Block: 4096   通常ファイル
Device: 902h/2306d      Inode: 15073327    Links: 1
Access: (0644/-rw-r--r--)  Uid: (10028/  kamipo)   Gid: (  501/     dev)
Access: 2009-04-06 16:44:20.000000000 +0900
Modify: 2009-04-06 16:44:20.000000000 +0900
Change: 2009-04-06 16:44:20.000000000 +0900
   </pre>
 </div>

 <div>
   <h2>./test_readの後</h2>
   <pre style="font-size: 20px;">
  File: `test.txt'
  Size: 5               Blocks: 8          IO Block: 4096   通常ファイル
Device: 902h/2306d      Inode: 15073327    Links: 1
Access: (0644/-rw-r--r--)  Uid: (10028/  kamipo)   Gid: (  501/     dev)
Access: 2009-04-06 16:44:56.000000000 +0900
Modify: 2009-04-06 16:44:20.000000000 +0900
Change: 2009-04-06 16:44:20.000000000 +0900
   </pre>
 </div>

 <div>
  <h2>strace</h2>
  <script type="text/javascript">
    s6.page({
       styleBase: 'takahashi'
    });
  </script>
 </div>

 <div>
   <h2>strace -c grep -r hoge ./</h2>
   <pre style="font-size: 13px;">
Process 364 detached
% time     seconds  usecs/call     calls    errors syscall
------ ----------- ----------- --------- --------- ----------------
 28.52    0.000312           0     20001           read
 22.76    0.000249           3        80           getdents64
 21.30    0.000233           0     10006           open
 16.73    0.000183           0     10001           stat64
 10.69    0.000117           0     10007           close
  0.00    0.000000           0         1           execve
  0.00    0.000000           0         3         3 access
  0.00    0.000000           0         3           brk
  0.00    0.000000           0         2           munmap
  0.00    0.000000           0         1           uname
  0.00    0.000000           0         1           mprotect
  0.00    0.000000           0         9           mmap2
  0.00    0.000000           0         5           fstat64
  0.00    0.000000           0         1           fcntl64
  0.00    0.000000           0         1           set_thread_areae
------ ----------- ----------- --------- --------- ----------------
100.00    0.001094                 50122         3 total
   </pre>
 </div>

 <div>
   <h2>read syscallの比較</h2>
   <ul>
     <li>atime:   0.0004161</li>
     <li>noatime: 0.0002531</li>
   </ul>
 </div>

 <div>
   <h2>CPU</h2>
   <div>
       <img src="img/cpu-week.png"/>
   </div>
 </div>

 <div>
   <h2>iostat</h2>
   <div>
       <img src="img/iostat-week.png"/>
   </div>
 </div>

 <div>
   <h2>Load average</h2>
   <div>
       <img src="img/load-week.png"/>
   </div>
 </div>

 <div>
  <h2>relatimeの話</h2>
  <script type="text/javascript">
    s6.page({
       styleBase: 'takahashi'
    });
  </script>
 </div>

 <div>
   <h2>参考</h2>
   <ul>
       <li>
       <a style="font-size: 13pt;" href="http://d.hatena.ne.jp/shiumachi/20080614/1213415948">
           atime関連マウントオプション使用時のディスク性能比較 - 科学と非科学の迷宮
       </a>
       </li>
   </ul>
 </div>

 <div>
  <h2>おわり</h2>
  <script type="text/javascript">
    s6.page({
       styleBase: 'takahashi'
    });
  </script>
 </div>

</body>
</html>
